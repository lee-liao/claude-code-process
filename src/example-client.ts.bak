/**
 * Example client demonstrating how to use the Claude Code Web API
 */

interface TaskRequest {
  taskType: "code-review" | "bug-fix" | "feature-implementation" | "documentation" | "custom";
  prompt?: string;
  promptFile?: string;
  model?: string;
  maxTurns?: number;
  allowedTools?: string;
  disallowedTools?: string;
  systemPrompt?: string;
  appendSystemPrompt?: string;
  timeoutSeconds?: number;
  outputSchema?: Record<string, any>;
  metadata?: Record<string, any>;
}

interface TaskResponse {
  taskId: string;
  status: "pending" | "running" | "completed" | "failed" | "timeout";
  result?: any;
  error?: string;
  executionMetrics?: {
    durationMs: number;
    numTurns: number;
    totalCostUsd: number;
    permissionDenials: number;
  };
  createdAt: string;
  startedAt?: string;
  completedAt?: string;
  metadata?: Record<string, any>;
}

class ClaudeCodeAPIClient {
  private baseUrl: string;
  private apiKey?: string;

  constructor(baseUrl: string = "http://localhost:3000", apiKey?: string) {
    this.baseUrl = baseUrl.replace(/\/$/, ""); // Remove trailing slash
    this.apiKey = apiKey;
  }

  private async makeRequest<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const url = `${this.baseUrl}${endpoint}`;
    const headers: HeadersInit = {
      "Content-Type": "application/json",
      ...options.headers,
    };

    if (this.apiKey) {
      headers["Authorization"] = `Bearer ${this.apiKey}`;
    }

    const response = await fetch(url, {
      ...options,
      headers,
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(`API Error (${response.status}): ${error.error || response.statusText}`);
    }

    return response.json();
  }

  async healthCheck(): Promise<any> {
    return this.makeRequest("/health");
  }

  async listTemplates(category?: string): Promise<any> {
    const query = category ? `?category=${encodeURIComponent(category)}` : "";
    return this.makeRequest(`/templates${query}`);
  }

  async getTemplate(taskType: string): Promise<any> {
    return this.makeRequest(`/templates/${taskType}`);
  }

  async submitTask(taskRequest: TaskRequest): Promise<TaskResponse> {
    return this.makeRequest("/tasks", {
      method: "POST",
      body: JSON.stringify(taskRequest),
    });
  }

  async getTask(taskId: string): Promise<TaskResponse> {
    return this.makeRequest(`/tasks/${taskId}`);
  }

  async cancelTask(taskId: string): Promise<any> {
    return this.makeRequest(`/tasks/${taskId}`, {
      method: "DELETE",
    });
  }

  async getStats(): Promise<any> {
    return this.makeRequest("/stats");
  }

  async waitForTask(
    taskId: string,
    options: {
      timeoutMs?: number;
      pollIntervalMs?: number;
      onProgress?: (status: TaskResponse) => void;
    } = {}
  ): Promise<TaskResponse> {
    const {
      timeoutMs = 300000, // 5 minutes default
      pollIntervalMs = 2000, // 2 seconds default
      onProgress,
    } = options;

    const startTime = Date.now();

    while (Date.now() - startTime < timeoutMs) {
      const task = await this.getTask(taskId);

      if (onProgress) {
        onProgress(task);
      }

      if (task.status === "completed" || task.status === "failed" || task.status === "timeout") {
        return task;
      }

      await new Promise(resolve => setTimeout(resolve, pollIntervalMs));
    }

    throw new Error(`Task ${taskId} did not complete within ${timeoutMs}ms`);
  }
}

// Example usage functions
async function exampleCodeReview() {
  const client = new ClaudeCodeAPIClient("http://localhost:3000", "your-api-key");

  console.log("Submitting code review task...");

  const task = await client.submitTask({
    taskType: "code-review",
    prompt: "Please review the authentication module in src/auth/ for security vulnerabilities and best practices.",
    maxTurns: 15,
    allowedTools: "Read,Grep,Edit,Write",
    metadata: {
      project: "my-app",
      module: "authentication",
    },
  });

  console.log(`Task submitted: ${task.taskId}`);
  console.log("Waiting for completion...");

  try {
    const result = await client.waitForTask(task.taskId, {
      onProgress: (status) => {
        console.log(`Status: ${status.status}`);
        if (status.executionMetrics) {
          console.log(`Duration: ${status.executionMetrics.durationMs}ms`);
        }
      },
    });

    console.log("Task completed!");
    console.log("Result:", JSON.stringify(result.result, null, 2));
    console.log("Metrics:", result.executionMetrics);
  } catch (error) {
    console.error("Task failed:", error);
  }
}

async function exampleFeatureImplementation() {
  const client = new ClaudeCodeAPIClient();

  const task = await client.submitTask({
    taskType: "feature-implementation",
    prompt: "Implement a user profile management feature with CRUD operations",
    model: "claude-4-0-sonnet-20250805",
    maxTurns: 20,
    outputSchema: {
      type: "object",
      properties: {
        implementation: { type: "string" },
        filesCreated: { type: "array", items: { type: "string" } },
        filesModified: { type: "array", items: { type: "string" } },
        apiEndpoints: {
          type: "array",
          items: {
            type: "object",
            properties: {
              method: { type: "string" },
              path: { type: "string" },
              description: { type: "string" },
            },
          },
        },
      },
      required: ["implementation", "filesCreated", "filesModified"],
    },
  });

  console.log(`Feature implementation task: ${task.taskId}`);

  const result = await client.waitForTask(task.taskId);

  if (result.status === "completed") {
    console.log("Feature implemented successfully!");
    console.log("Files created:", result.result.filesCreated);
    console.log("API endpoints:", result.result.apiEndpoints);
  }
}

async function exampleBatchProcessing() {
  const client = new ClaudeCodeAPIClient();
  const tasks = [
    "Review the authentication module",
    "Analyze database query performance",
    "Check for security vulnerabilities in the API",
    "Review error handling patterns",
  ];

  console.log("Submitting batch tasks...");
  const submittedTasks = await Promise.all(
    tasks.map((prompt, index) =>
      client.submitTask({
        taskType: "code-review",
        prompt,
        metadata: { batchId: "review-2024-01", index },
      })
    )
  );

  console.log(`Submitted ${submittedTasks.length} tasks`);

  // Wait for all tasks to complete
  const results = await Promise.allSettled(
    submittedTasks.map((task) => client.waitForTask(task.taskId))
  );

  console.log("Batch results:");
  results.forEach((result, index) => {
    if (result.status === "fulfilled") {
      console.log(`Task ${index + 1}: ${result.value.status}`);
    } else {
      console.log(`Task ${index + 1}: Failed - ${result.reason}`);
    }
  });
}

// CLI runner
async function main() {
  const command = process.argv[2];

  switch (command) {
    case "code-review":
      await exampleCodeReview();
      break;
    case "feature":
      await exampleFeatureImplementation();
      break;
    case "batch":
      await exampleBatchProcessing();
      break;
    case "health":
      const client = new ClaudeCodeAPIClient();
      const health = await client.healthCheck();
      console.log("Health:", health);
      break;
    case "templates":
      const templateClient = new ClaudeCodeAPIClient();
      const templates = await templateClient.listTemplates();
      console.log("Available templates:", templates);
      break;
    default:
      console.log("Usage:");
      console.log("  bun run example-client.ts code-review    # Run code review example");
      console.log("  bun run example-client.ts feature       # Run feature implementation example");
      console.log("  bun run example-client.ts batch         # Run batch processing example");
      console.log("  bun run example-client.ts health        # Check API health");
      console.log("  bun run example-client.ts templates     # List available templates");
  }
}

// Run if executed directly
if (import.meta.main) {
  main().catch(console.error);
}

export { ClaudeCodeAPIClient, TaskRequest, TaskResponse };